name: Run Strategy

on:
  workflow_dispatch:

jobs:
  run-strategy:
    runs-on: ubuntu-latest
    environment: copilot
    env:
      RPC_URL: ${{ secrets.RPC_URL }}
      RPC_FALLBACKS: ${{ secrets.RPC_FALLBACKS }}
      PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
      VAULT_ADDRESS: ${{ secrets.VAULT_ADDRESS }}
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TELEGRAM_CHATID: ${{ secrets.TELEGRAM_CHATID }}
      ALCHEMY_API_KEY: ${{ secrets.ALCHEMY_API_KEY }}
      
      # Protocol addresses (public)
      AAVE_POOL_ADDRESS_8453: ${{ vars.AAVE_POOL_ADDRESS_8453 || '0xA238Dd80C259a72e81d7e4664a9801593F98d1c5' }}
      AAVE_WETH_GATEWAY_8453: ${{ vars.AAVE_WETH_GATEWAY_8453 || '' }}
      AERODROME_ROUTER_8453: ${{ vars.AERODROME_ROUTER_8453 || '0xcF77a3Ba9A5CA399B7c97c74d54e5b1Beb874E43' }}
      
      # Base chain token addresses (public addresses, can use vars with defaults)
      WETH_TOKEN_ADDRESS: ${{ vars.WETH_TOKEN_ADDRESS || '0x4200000000000000000000000000000000000006' }}
      USDC_BASE: ${{ vars.USDC_BASE || '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913' }}
      USDBC_BASE: ${{ vars.USDBC_BASE || '0xd9aAEc86B65D86f6A7B5B1b0c42FFA531710b6CA' }}
      USDT_BASE: ${{ vars.USDT_BASE || '0xfde4C96c8593536E31F229EA8f37b2ADa2699bb2' }}
      CBBTC_BASE: ${{ vars.CBBTC_BASE || '0xcbB7C0000aB88B473b1f5aFd9ef808440eed33Bf' }}
      CBETH_BASE: ${{ vars.CBETH_BASE || '0x2Ae3F1Ec7F1F5012CFEab0185bfc7aa3cf0DEc22' }}
      WSTETH_BASE: ${{ vars.WSTETH_BASE || '0xc1CBa3fCea344f92D9239c08C0568f6F2F0ee452' }}
      
      # Beefy vault addresses
      BEEFY_USDC_CBBTC_VAULT: ${{ secrets.BEEFY_USDC_CBBTC_VAULT }}
      BEEFY_USDC_USDT_VAULT: ${{ secrets.BEEFY_USDC_USDT_VAULT }}
      BEEFY_WETH_USDC_VAULT: ${{ secrets.BEEFY_WETH_USDC_VAULT }}
      BEEFY_CBETH_WETH_VAULT: ${{ secrets.BEEFY_CBETH_WETH_VAULT }}
      BEEFY_WETH_USDT_VAULT: ${{ secrets.BEEFY_WETH_USDT_VAULT }}
      
      # ERC-4626 vault addresses
      WETH_YIELD_VAULT_BASE: ${{ vars.WETH_YIELD_VAULT_BASE || '0x38989BBA00BDF8181F4082995b3DEAe96163aC5D' }}
      CBBTC_ERC4626_VAULT: ${{ vars.CBBTC_ERC4626_VAULT || '' }}
      USDC_ERC4626_VAULT: ${{ vars.USDC_ERC4626_VAULT || '0xef417a2512C5a41f69AE4e021648b69a7CdE5D03' }}
      
      # Yearn vault addresses
      YEARN_USDC_VAULT_BASE: ${{ vars.YEARN_USDC_VAULT_BASE || '' }}
      YEARN_WETH_VAULT_BASE: ${{ vars.YEARN_WETH_VAULT_BASE || '' }}
      YEARN_CBBTC_VAULT_BASE: ${{ vars.YEARN_CBBTC_VAULT_BASE || '' }}
      
      # Compound V3 (Comet) market addresses
      COMET_USDC_MARKET_BASE: ${{ vars.COMET_USDC_MARKET_BASE || '0x46e6b214b524310239732D51387075E0e70970bf' }}
      COMET_USDBC_MARKET_BASE: ${{ vars.COMET_USDBC_MARKET_BASE || '0x9c4ec768c28520B50860ea7a15bd7213a9fF58bf' }}
      
      # Moonwell (Compound V2 fork) cToken addresses
      MOONWELL_CBETH_CTOKEN: ${{ vars.MOONWELL_CBETH_CTOKEN || '0x3bf93770f2d4a794c3d9EBEfBAeBAE2a8f09A5E5' }}
      MOONWELL_WETH_CTOKEN: ${{ vars.MOONWELL_WETH_CTOKEN || '0x628ff693426583D9a7FB391E54366292F509D457' }}
      MOONWELL_USDC_CTOKEN: ${{ vars.MOONWELL_USDC_CTOKEN || '0xEdc817A28E8B93B03976FBd4a3dDBc9f7D176c22' }}
      
      # Morpho Blue vault addresses
      MORPHO_USDC_VAULT_BASE: ${{ vars.MORPHO_USDC_VAULT_BASE || '0xef417a2512C5a41f69AE4e021648b69a7CdE5D03' }}
      MORPHO_WETH_VAULT_BASE: ${{ vars.MORPHO_WETH_VAULT_BASE || '0x38989BBA00BDF8181F4082995b3DEAe96163aC5D' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup tools
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Resolve Beefy vaults (Base)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ENV_NAME: copilot
        run: |
          scripts/resolve_beefy_vaults.sh
          echo "Beefy vaults (runtime):"
          env | grep -E '^BEEFY_.*_VAULT=' || true

      - name: Resolve Yearn vaults (Base)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ENV_NAME: copilot
        run: |
          scripts/resolve_yearn_vaults.sh
          echo "Yearn vaults (runtime):"
          env | grep -E '^YEARN_.*_VAULT=' || true

      - name: Resolve Compound/Moonwell markets (Base)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ENV_NAME: copilot
        run: |
          scripts/resolve_compound_markets.sh
          echo "Compound/Moonwell markets (runtime):"
          env | grep -E '^(COMET_|MOONWELL_)' || true

      - name: Resolve ERC-4626 vaults (Base)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ENV_NAME: copilot
        run: |
          scripts/resolve_erc4626_vaults.sh
          echo "ERC-4626 vaults (runtime):"
          env | grep -E '_ERC4626_VAULT=' || true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install -r bots/wave_rotation/requirements.txt

      - name: Run strategy
        run: python bots/wave_rotation/strategy.py
